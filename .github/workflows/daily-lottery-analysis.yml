name: Daily Lottery Analysis

on:
  schedule:
    # ç¬¬ä¸€æ¬¡ï¼šæ¯å¤©00:10 UTCï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´08:10ï¼‰
    - cron: '10 0 * * *'
    # ç¬¬äºŒæ¬¡ï¼šæ¯å¤©07:30 UTCï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´15:30ï¼‰
    - cron: '30 7 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib openpyxl requests
      
      - name: Run lottery analysis
        run: |
          echo "å¼€å§‹æ‰§è¡Œå½©ç¥¨åˆ†æè„šæœ¬..."
          echo "è§¦å‘æ—¶é—´ï¼ˆUTCï¼‰: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "è§¦å‘æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          python deepseek_cp2025.py
          echo "è„šæœ¬æ‰§è¡Œå®Œæˆ"
      
      - name: Commit and push report
        run: |
          echo "å‡†å¤‡æäº¤æŠ¥å‘Šæ–‡ä»¶..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "deepseek_cp_report.html" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # é…ç½®Git
          git config --local user.email "actions@github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ–‡ä»¶
          git add deepseek_cp_report.html
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜åŒ–å¯æäº¤"
          else
            # è·å–å½“å‰æ—¶é—´ç”¨äºæäº¤ä¿¡æ¯
            BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ”® è‡ªåŠ¨æ›´æ–°å½©ç¥¨åˆ†ææŠ¥å‘Š ${BEIJING_TIME}"
            git pull origin main --rebase
            git push origin main
            echo "âœ… æŠ¥å‘Šæäº¤å®Œæˆ"
          fi
      
      - name: Upload report as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: lottery-report-$(date +%Y%m%d-%H%M)
          path: deepseek_cp_report.html
          retention-days: 7
      
      - name: Show summary
        run: |
          echo "========================================"
          echo "ğŸ° å½©ç¥¨åˆ†æä»»åŠ¡å®Œæˆ"
          echo "ğŸ“… UTCæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ¯ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ -f "deepseek_cp_report.html" ]; then
            file_size=$(wc -c < deepseek_cp_report.html)
            echo "âœ… æŠ¥å‘Šæ–‡ä»¶: deepseek_cp_report.html"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: ${file_size} å­—èŠ‚"
            echo "ğŸŒ è®¿é—®åœ°å€: https://github.com/cloudplains/jnsj/blob/main/deepseek_cp_report.html"
            echo "ğŸ“¥ Artifact: lottery-report-$(date +%Y%m%d-%H%M)"
          else
            echo "âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          fi
          
          echo "========================================"